package server

import (
	"bytes"
	"reflect"
	"testing"
)

func TestBuild(t *testing.T) {
	input := new(ResponseError)
	input.ResponseCode = 0xff
	input.ErrorCode = 1054
	input.SQLState = []byte("42S22")
	input.Errormessage = "Unknown column 'version' in 'field list'"

	actual := input.Build()
	except := []byte{
		0xff, 0x1e, 0x04, 0x23, 0x34, 0x32, 0x53, 0x32,
		0x32, 0x55, 0x6e, 0x6b, 0x6e, 0x6f, 0x77, 0x6e,
		0x20, 0x63, 0x6f, 0x6c, 0x75, 0x6d, 0x6e, 0x20,
		0x27, 0x76, 0x65, 0x72, 0x73, 0x69, 0x6f, 0x6e,
		0x27, 0x20, 0x69, 0x6e, 0x20, 0x27, 0x66, 0x69,
		0x65, 0x6c, 0x64, 0x20, 0x6c, 0x69, 0x73, 0x74,
		0x27,
	}

	if !bytes.Equal(actual, except) {
		t.Errorf("input: \n [%+v] \n actual \n [%+v] \n except \n [%+v] \n \n", input, actual, except)
	}
}

func TestResolve(t *testing.T) {
	input := []byte{
		0xff, 0x1e, 0x04, 0x23, 0x34, 0x32, 0x53, 0x32,
		0x32, 0x55, 0x6e, 0x6b, 0x6e, 0x6f, 0x77, 0x6e,
		0x20, 0x63, 0x6f, 0x6c, 0x75, 0x6d, 0x6e, 0x20,
		0x27, 0x76, 0x65, 0x72, 0x73, 0x69, 0x6f, 0x6e,
		0x27, 0x20, 0x69, 0x6e, 0x20, 0x27, 0x66, 0x69,
		0x65, 0x6c, 0x64, 0x20, 0x6c, 0x69, 0x73, 0x74,
		0x27,
	}

	actual := new(ResponseError)
	actual.Resolve(input, 49)

	except := new(ResponseError)
	except.ResponseCode = 0xff
	except.ErrorCode = 1054
	except.SQLState = []byte("42S22")
	except.Errormessage = "Unknown column 'version' in 'field list'"

	if !reflect.DeepEqual(actual, except) {
		t.Errorf("input: \n [%+v] \n actual \n [%+v] \n except \n [%+v] \n \n", input, actual, except)
	}
}
